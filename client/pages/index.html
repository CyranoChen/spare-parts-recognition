<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Spare Parts Recognition</title>
    <link rel="shortcut icon" href="/favicon" />
    <!-- twitter-bootstrap -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- font-awesome-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- admin-lte -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.10/css/AdminLTE.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.10/css/skins/_all-skins.min.css">
</head>

<body class="skin-blue hold-transition sidebar-mini sidebar-collapse">
    <div class="wrapper">
        <header id="header" class="main-header"></header>
        <aside id="sidebar" class="main-sidebar sidebar-dark-primary elevation-4"></aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <section class="content-header">
                <h1>
                    Console
                    <small>Console of Spare Parts Recognition</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                    <li class="active">Console</li>
                </ol>
            </section>
            <!-- Main content -->
            <section class="content">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Upload a sample image to recognize</h3>
                    </div>
                    <!-- /.box-header -->
                    <!-- form start -->
                    <form class="form-horizontal">
                        <div class="box-body">
                            <div class="form-group">
                                <label for="tb-filename" class="col-sm-3 control-label">file name</label>

                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="tb-filename" placeholder="file name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="tb-image" class="col-sm-3 control-label">image</label>

                                <div class="col-sm-9">
                                    <input type="file" class="form-control" id="tb-image" placeholder="Password">
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-3 control-label">
                                    <img id="img-preview" for="tb-image" />
                                    <canvas id="cvs-image" class="hide"></canvas>
                                </div>
                                <div class="col-sm-9">
                                    <textarea id="ta-image-base64" class="form-control" rows="8"
                                        placeholder="data:image/jpeg;base64" disabled="disabled"></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- /.box-body -->
                        <div class="box-footer">
                            <button type="reset" id="btn-reset" class="btn btn-default pull-right">Cancel</button>
                            <button type="button" id="btn-recognize" class="btn btn-info pull-right"
                                style="margin-right: 5px; display: none">Recognize</button>
                        </div>
                        <!-- /.box-footer -->
                    </form>
                </div>
                <div id="pnl-result" class="box box-primary" style="display: none">
                    <div class="box-header with-border">
                        <h3 class="box-title">Response</h3>
                    </div>
                    <div class="box-body">
                        <form class="form-horizontal">
                            <div class="box-body">
                                <div class="form-group">
                                    <label for="ta-raw-response" class="col-sm-3 control-label">response</label>
                                    <div class="col-sm-9">
                                        <textarea id="ta-raw-response" class="form-control" rows="5"></textarea>
                                    </div>
                                </div>
                            </div>
                            <!-- /.box-body -->
                        </form>
                    </div>
                </div>
            </section>
        </div>

        <!-- Main Footer -->
        <footer id="footer" class="main-footer"></footer>
    </div>
    <!-- ./wrapper -->

    <!-- REQUIRED SCRIPTS -->
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Adminlte -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.10/js/adminlte.min.js"></script>

    <script src="../dist/js/main.js"></script>

    <script type="text/javascript">
        $(function () {
            $("#header").load("./shared/header.html");
            $("#footer").load("./shared/footer.html");

            $("#sidebar").load("./shared/sidebar.html", function () {
                $(".sidebar li.index-page").addClass("active");
                $(".sidebar li.labels-page").removeClass("active");
            });

            $("#tb-image").on('change', (e) => {
                if (typeof window.FileReader !== 'function') {
                    alert("The file API isn't supported on this browser yet.");
                    return;
                }

                let file = e.target.files[0];
                console.log(file);
                $("#ta-image-base64").val('loading ...');
                $("button#btn-recognize").hide();

                let fr = new FileReader();
                fr.onload = () => {
                    let img = new Image();
                    img.onload = () => {
                        let canvas = document.getElementById("cvs-image");
                        canvas.width = img.width;
                        canvas.height = img.height;
                        let ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0);

                        $("#ta-image-base64").val(canvas.toDataURL(file.type));
                        $("button#btn-recognize").show();
                    };

                    img.src = fr.result;
                    $("#img-preview").prop('src', img.src).css('max-width', '200px').css(
                        'max-height', '168px');

                    $("#tb-filename").val(file.name);
                };
                fr.readAsDataURL(file);
            });

            $("button#btn-reset").click(() => {
                $("#img-preview").prop('src', '');
                $("#pnl-result").hide().find("#ta-raw-response").val('');
                $("button#btn-recognize").hide().prop('disabled', false);
            });

            $("button#btn-recognize").click(() => {
                var filename = $("#tb-filename").val();
                var imageBase64 = $("#ta-image-base64").val();

                if (filename != '' && imageBase64 != '') {
                    $("button#btn-recognize").prop('disabled', true);
                    const settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": config.API_SERVER_PATH + "/recognize",
                        "method": "POST",
                        "headers": {
                            "Content-Type": "application/json",
                            "cache-control": "no-cache",
                        },
                        "processData": false,
                        "data": JSON.stringify({
                            "filename": filename,
                            "image": imageBase64
                        })
                    };

                    $.ajax(settings).done(function (response) {
                        console.log(response);
                        $("#ta-raw-response").val(response);
                        if (response.state === 'success' && response.data.length > 0) {
                            $.each(response.data, function (i, obj) {
                                alert(i, obj);
                            });
                        }
                        $("#pnl-result").fadeIn(1000);
                        $("button#btn-recognize").prop('disabled', false);
                    }).fail(() => {
                        alert('server unavailable');
                    });
                } else {
                    alert('please upload the input image');
                }
            });
        });
    </script>
</body>

</html>